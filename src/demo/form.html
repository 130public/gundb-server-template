<!DOCTYPE html>
<head>
<style>
*, :after, :before {
    box-sizing: inherit;
}
html, body{ padding: 5vw; margin: 0; font-family:system-ui;}
h1{padding:1rem 0 1rem;}
h2{
  border-top:1px solid plum;
  margin:4rem 0 0;
  padding:2rem 0 1rem;
}
input, textarea,button{
  font-size:1.5rem;
  margin:0 auto 1rem;
}
label{
  display: block;
  font-size:1.5rem;
  margin:0 0 1rem;
}
input, textarea{padding:0.5rem;width:80vw;}
textarea{height:50vh;}

</style>
</head>
<body>
  <h1>Your GunDB portal</h1>
  <h2>Define your data stores</h2>
  <form id="storage_form">
    <label>Your list of relays</label>
    <input id="storage_input" value="" placeholder=""></input>
    <button type="submit">Update relay list</button>
  </form>
  <h2>View and manage data</h2>
  <form id="data_form">
    <label>Enter you uid (First letter of your name + '_id')</label>
    <input id="uid_input" value="k_id" placeholder=""></input>
    <button type="submit">Get data</button>
  </form>
  <textarea id="data_input" placeholder="paste here!"></textarea>

  
  
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script>
    let updateStore = (storeKey, data) => {
      localStorage.setItem(storeKey,data);
    }
    let readStore = (storeKey, callback) => {
      let data;
      local = localStorage.getItem(storeKey);

      if (!local) {
        console.log('null');
        data = defaultServers;
      }else{
        data = local;
      }
      callback(data);
    }
  </script>
  <script>
    //DEFAULTS
    let defaultServers = {"servers":['http://localhost:8080/gun']};
    
    /****************************
    Handle storage
    ****************************/
    let storage_form = document.getElementById('storage_form');
    let storage_input = document.getElementById('storage_input');
    storage_form.addEventListener("submit", (e) => {
      e.preventDefault();
      console.log('update storage');
      updateStore('gunServers',storage_input.value);
    });
    /****************************
    Handle data
    ****************************/
    let user_module = 'module_tj'
    let data_id = document.getElementById('uid_input');
    let data_form = document.getElementById('data_form');
    let data_input = document.getElementById('data_input');
    data_form.addEventListener("submit", (e) => {
      e.preventDefault();
      console.log('retrieve data');
      manageData();
    });
    let manageData = () => {
      let user_id = (!data_id) ? 'default_id' : data_id.value;
      let module_data = gun.get(user_id).get(user_module);
      module_data.on((data) => { data_input.value = data });
      data_input.oninput = () => { module_data.put(data_input.value) };
    }

    /****************************
    Initiate
    ****************************/
    readStore('gunServers', d => {
      gunServers = JSON.parse(d);

      console.log(gunServers['servers']);

      //
      gun = Gun(gunServers.servers);
      storage_input.value = JSON.stringify(gunServers);
    })

    /*
    company = gun.get('startup').put({
      name: "hype",
      profitable: false,
      address: {
        street: "123 Hipster Lane",
        city: "San Francisco",
        state: "CA",
        country: "USA"
      }
    });
    */

  </script>
  </body>
</html>